# .github/workflows/deploy.yml
name: Deploy Alfa-Drones para Hostinger
on:
  push:
    branches:
      - main
jobs:
  deploy:
    name: Deploy do Projeto
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout do Repositório
        uses: actions/checkout@v4
      - name: 2. Configurar PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, openssl, pdo, mysql, dom, curl, fileinfo, bcmath
          tools: composer
      - name: 3. Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: 4. Instalar Dependências NPM
        run: npm install
      - name: 5. Buildar Assets (Vite)
        run: npm run build --if-present
        
      - name: 6. Conectar, Puxar, Construir e Ativar
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_PORT }}
          script: |
            cd domains/rafael.software/public_html/alfadrones
            echo "Navegou para o diretório $(pwd)"
            rm -f .env
            
            echo "Criando novo arquivo .env..."
            
            cat <<EOF > .env
            APP_NAME="Alfadrones"
            APP_ENV=production
            APP_DEBUG=false
            APP_URL=${{ secrets.APP_URL }}
            APP_KEY=${{ secrets.APP_KEY }}

            LOG_CHANNEL=stack
            LOG_LEVEL=debug

            DB_CONNECTION=mysql
            DB_HOST=127.0.0.1
            DB_PORT=3306
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            # Exemplo (baseado no seu .env.example):
            SESSION_DRIVER=database
            QUEUE_CONNECTION=database
            CACHE_STORE=database

            # Se você usa e-mails, adicione os secrets de MAIL_* aqui
            # MAIL_MAILER=smtp
            # MAIL_HOST=${{ secrets.MAIL_HOST }}
            # MAIL_PORT=${{ secrets.MAIL_PORT }}
            # ...etc
            EOF
            
            echo "Arquivo .env criado com sucesso."
            
            # --- EXECUÇÃO DOS COMANDOS LARAVEL ---
            
            echo "Instalando dependências do Composer..."
            # Instala dependências do Composer (sem dev)
            php8.2 /usr/local/bin/composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader
            
            echo "Executando migrações do banco..."
            # Roda as migrações (o --force é vital para produção)
            php8.2 artisan migrate --force
            
            echo "Limpando e criando caches..."
            # Limpa e cria caches de produção
            php8.2 artisan config:cache
            php8.2 artisan route:cache
            php8.2 artisan view:cache
            
            echo "Recriando link de armazenamento..."
            # Recria o link de armazenamento
            # Remove o link antigo para evitar erros e depois recria
            rm -f public/storage
            php8.2 artisan storage:link
            
            echo "Deploy finalizado com sucesso!"
